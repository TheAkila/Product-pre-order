rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Orders collection
    match /orders/{orderId} {
      // Allow anyone to create orders (for pre-order form submission)
      allow create: if request.resource.data.keys().hasAll(['name', 'phone', 'quantity', 'amount', 'paymentMethod', 'paymentStatus', 'createdAt'])
            && request.resource.data.name is string
            && request.resource.data.phone is string
            && request.resource.data.quantity is int
            && request.resource.data.quantity > 0
            && request.resource.data.amount is number
            && request.resource.data.paymentMethod == 'PAYHERE'
            && request.resource.data.paymentStatus == 'PENDING_PAYMENT';
      
      // Allow reading orders (for admin dashboard)
      allow read: if true;
      
      // Allow updates for payment status and delivery status
      // Simplified rule - only allow updating specific fields
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['paymentStatus', 'paymentId', 'updatedAt', 'deliveryStatus']);
      
      // Allow deletions from admin operations
      allow delete: if true;
    }
  }
}
